version: 2.1

orbs:
  node: circleci/node@5

jobs:
  run-ui-tests:
    docker:
      - image: cimg/node:18.16-browsers
    steps:
      - checkout

      - run:
          name: Install UI dependencies
          command: |
            cd ui_tests
            npm ci

      - run:
          name: Start ChromeDriver
          command: |
            npx chromedriver --port=9515 --url-base=wd/hub > chromedriver.log 2>&1 &
            sleep 5

      - run:
          name: Run Nightwatch UI Tests
          command: |
            cd ui_tests
            npm run test
          when: always

      - store_artifacts:
          path: ui_tests/tests_output/nightwatch-html-report
          destination: nightwatch-report

  run-api-tests:
    docker:
      - image: cimg/node:18.16
    steps:
      - checkout

      - run:
          name: Install API dependencies
          command: |
            cd api_tests
            npm ci

      - run:
          name: Start Mock Server & Wait
          command: |
            cd api_tests
            nohup npm run dev > server.log 2>&1 &
            sleep 5

      - run:
          name: Show server logs
          command: cat api_tests/server.log

      - run:
          name: Run API Tests
          command: |
            cd api_tests
            npm run test
          when: always

      - store_artifacts:
          path: api_tests/report
          destination: api-test-report

workflows:
  version: 2
  full-test-workflow:
    jobs:
      - run-ui-tests
      - run-api-tests:
          requires:
            - run-ui-tests
